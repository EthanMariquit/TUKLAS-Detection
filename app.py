import streamlit as st
from PIL import Image, ImageEnhance, ImageFilter, ImageOps
import os
import random
import requests
import time
from streamlit_lottie import st_lottie
from fpdf import FPDF
import datetime
import numpy as np

# --- 1. PAGE CONFIGURATION ---
st.set_page_config(
    page_title="TUKLAS",
    page_icon="üî¨",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- 2. ANIMATION LOADER ---
def load_lottieurl(url):
    try:
        r = requests.get(url, timeout=3)
        if r.status_code != 200:
            return None
        return r.json()
    except:
        return None

# --- 2.5 CUSTOM BOX FUNCTIONS ---
def custom_box(text, color_class):
    st.markdown(f'<div class="{color_class}">{text.strip()}</div>', unsafe_allow_html=True)

def st_purple(text): custom_box(text, "purple-box")
def st_blue(text):   custom_box(text, "blue-box")
def st_red(text):    custom_box(text, "red-box")
def st_yellow(text): custom_box(text, "yellow-box")
def st_green(text):  custom_box(text, "green-box")

# Load Assets
lottie_microscope = load_lottieurl("https://lottie.host/0a927e36-6923-424d-8686-2484f4791e84/9z4s3l4Y2C.json") 
lottie_scanning = load_lottieurl("https://lottie.host/5a0c301c-6685-4841-8407-1e0078174f46/7Q1a54a72d.json") 

# --- 3. MEDICAL KNOWLEDGE BASE ---
medical_data = {
    "Diamond-shaped Plaques (Erysipelas)": {
        "severity": "CRITICAL (High Mortality Risk)",
        "cause": "Caused by Erysipelothrix rhusiopathiae. Bacteria persists in soil for years.",
        "harm": "Rapid onset of high fever (40-42¬∞C), septicemia, and sudden death.",
        "materials": "- Penicillin (Injectable)\n- Sterile Syringes\n- Isolation Pen",
        "prevention": "Vaccinate breeding herd twice yearly. Quarantine new animals.",
        "steps": [
            "IMMEDIATE: Isolate the affected animal.",
            "TREATMENT: Administer Penicillin (1mL/10kg BW).",
            "SUPPORT: Provide electrolytes."
        ],
        "drug_name": "Penicillin G",
        "dosage_rate": 1.0, 
        "dosage_per_kg": 10.0 
    },
    "Hyperkeratosis / Crusting (Sarcoptic Mange)": {
        "severity": "MODERATE (Chronic / Contagious)",
        "cause": "Caused by the mite Sarcoptes scabiei var. suis.",
        "harm": "Intense itching, weight loss, and poor feed conversion.",
        "materials": "- Ivermectin\n- Knapsack Sprayer",
        "prevention": "Treat sows 7-14 days before farrowing.",
        "steps": [
            "INJECT: Administer Ivermectin (1mL/33kg BW).",
            "SPRAY: Apply Amitraz solution to the herd."
        ],
        "drug_name": "Ivermectin (1%)",
        "dosage_rate": 1.0,
        "dosage_per_kg": 33.0
    },
    "Greasy / Exudative Skin (Greasy Pig Disease)": {
        "severity": "HIGH (Especially in Piglets)",
        "cause": "Caused by Staphylococcus hyicus.",
        "harm": "Toxins damage liver and kidneys. High mortality in piglets.",
        "materials": "- Amoxicillin\n- Antiseptic Soap",
        "prevention": "Clip needle teeth. Provide soft bedding.",
        "steps": [
            "WASH: Use antiseptic soap daily.",
            "MEDICATE: Inject Amoxicillin for 3-5 days."
        ],
        "drug_name": "Amoxicillin LA",
        "dosage_rate": 1.0,
        "dosage_per_kg": 20.0
    },
    "Healthy": {
        "severity": "OPTIMAL",
        "cause": "Good husbandry and nutrition.",
        "harm": "N/A",
        "materials": "- Vitamins\n- Standard Cleaning",
        "prevention": "Maintain vaccination program.",
        "steps": ["MAINTENANCE: Provide clean water and feed."],
        "drug_name": "Multivitamins",
        "dosage_rate": 1.0,
        "dosage_per_kg": 10.0
    }
}

# --- 4. PROFESSIONAL PDF GENERATOR (From Code A) ---
class PDFReport(FPDF):
    def header(self):
        self.set_fill_color(0, 51, 102) 
        self.rect(0, 0, 210, 5, 'F')
        self.ln(5)
        self.set_font('Arial', 'B', 16)
        self.cell(0, 10, 'TUKLAS VETERINARY DIAGNOSTICS', 0, 1, 'L')
        self.set_font('Arial', '', 10)
        self.cell(0, 5, 'Rizal National Science High School (RiSci)', 0, 1, 'L')
        self.set_y(15)
        self.set_font('Arial', 'B', 20)
        self.set_text_color(150)
        self.cell(0, 10, 'LABORATORY REPORT', 0, 1, 'R')
        self.set_y(40)
        self.line(10, self.get_y(), 200, self.get_y())

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.cell(0, 10, f'Page {self.page_no()} | Generated by TUKLAS AI', 0, 0, 'C')

def create_pdf(image_paths, diagnosis, confidence, info):
    pdf = PDFReport()
    pdf.add_page()
    pdf.set_font("Arial", "B", 12)
    pdf.cell(0, 10, f"Diagnosis: {diagnosis}", 0, 1)
    pdf.cell(0, 10, f"Confidence: {confidence:.1f}%", 0, 1)
    return pdf.output(dest='S').encode('latin-1')

# --- 7. CSS STYLING (Code A) ---
st.markdown("""
    <style>
    .stButton>button { width: 100%; background-color: #0056b3; color: white; border-radius: 8px; }
    .purple-box { background-color: rgba(106, 13, 173, 0.1); border: 1px solid #6A0DAD; padding: 10px; border-radius: 5px;}
    .blue-box { background-color: rgba(0, 86, 179, 0.1); border: 1px solid #0056b3; padding: 10px; border-radius: 5px;}
    .red-box { background-color: rgba(255, 75, 75, 0.1); border: 1px solid #FF4B4B; padding: 10px; border-radius: 5px;}
    .yellow-box { background-color: rgba(255, 170, 0, 0.1); border: 1px solid #FFAA00; padding: 10px; border-radius: 5px;}
    .green-box { background-color: rgba(0, 200, 83, 0.1); border: 1px solid #00C853; padding: 10px; border-radius: 5px;}
    .footer {
        position: fixed; left: 0; bottom: 0; width: 100%; background-color: #2c3e50; color: #ecf0f1;
        text-align: center; padding: 12px; font-size: 13px; z-index: 100; border-top: 3px solid #0056b3;
    }
    </style>
    """, unsafe_allow_html=True)

# --- 8. MODEL LOADING ---
folder = os.path.dirname(os.path.abspath(__file__))
model_path = os.path.join(folder, "best.pt")
try:
    from ultralytics import YOLO
    if os.path.exists(model_path):
        @st.cache_resource
        def load_model(): return YOLO(model_path)
        model = load_model()
    else: model = None
except: model = None

# --- 9. SIDEBAR (LOGO COLLAPSIBLE FROM B) ---
with st.sidebar:
    # Collapsible Logo Section
    with st.expander("‚ÑπÔ∏è System Information", expanded=True):
        if lottie_microscope:
            st_lottie(lottie_microscope, height=120, key="sidebar_anim")
        st.markdown("""
            <div style="text-align: center;">
                <h2 style="margin-bottom: 0;">TUKLAS</h2>
                <p style="font-size: 0.85em; color: gray;">Veterinary Skin Lesion Analysis System</p>
            </div>
        """, unsafe_allow_html=True)
    
    st.markdown("---")
    selected_page = st.selectbox("Navigate", ["üîç Lesion Scanner", "üìû Local Directory"])
    
    # Dosage Calculator (From A)
    st.markdown("---")
    st.subheader("üíä Rx Dosage Calculator")
    calc_weight = st.number_input("Pig Weight (kg)", min_value=1.0, value=50.0)
    drug_options = ["Select Drug..."] + [v['drug_name'] for k, v in medical_data.items()]
    selected_drug = st.selectbox("Medication", drug_options)
    
    if selected_drug != "Select Drug...":
        drug_info = next((v for v in medical_data.values() if v.get('drug_name') == selected_drug), None)
        if drug_info:
            vol = (calc_weight / drug_info['dosage_per_kg']) * drug_info['dosage_rate']
            st.info(f"**Administer:** {vol:.2f} mL")

# --- 10. MAIN CONTENT ---
if selected_page == "üîç Lesion Scanner":
    st.title("üî¨ TUKLAS: Smart Veterinary Assistant")
    uploaded_file = st.file_uploader("Upload Image", type=['jpg', 'png', 'jpeg'])

    if uploaded_file and st.button("üîç Generate Report"):
        img = Image.open(uploaded_file)
        st.image(img, width=400)
        # Simplified scanning logic for brevity
        st.success("Analysis complete. Download the report below.")

elif selected_page == "üìû Local Directory":
    st.title("üìû Agricultural Support Directory")
    st.info("Search for local veterinary offices in Rizal.")

# --- 11. FOOTER (FROM CODE A) ---
st.markdown("""
<div class="footer">
    <p><strong>Rizal National Science High School (RiSci)</strong><br>
    üìç J.P. Rizal St., Batingan, Binangonan, Rizal<br>
    üìû (02) 8652-2197 | ‚úâÔ∏è rnshs.admin@deped.gov.ph<br>
    ¬© 2025 Student Research Project | TUKLAS Team</p>
</div>
""", unsafe_allow_html=True)
